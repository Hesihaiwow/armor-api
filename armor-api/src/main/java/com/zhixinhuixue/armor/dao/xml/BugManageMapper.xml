<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhixinhuixue.armor.dao.IZSYBugManageMapper">
    <resultMap id="BaseResultMap" type="com.zhixinhuixue.armor.model.pojo.BugManage">
        <id column="id" jdbcType="BIGINT" property="id" />
        <result column="description" jdbcType="VARCHAR" property="description" />
        <result column="project_id" jdbcType="BIGINT" property="projectId" />
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    </resultMap>

    <resultMap id="ResultMap" type="com.zhixinhuixue.armor.model.bo.BugManageListBO" extends="BaseResultMap">
        <result column="projectName" jdbcType="VARCHAR" property="projectName" />
    </resultMap>

    <resultMap id="DetailResultMap" type="com.zhixinhuixue.armor.model.bo.BugManageBO" extends="BaseResultMap">
        <collection property="bugUsers" column="id"
                    select="com.zhixinhuixue.armor.dao.IZSYBugUserMapper.selectDetailByBugId"
                    ofType="com.zhixinhuixue.armor.model.bo.BugUserBo">
        </collection>
    </resultMap>
    
    <insert id="insertBug" parameterType="com.zhixinhuixue.armor.model.pojo.BugManage">
        insert into bug_manage (id, description, project_id, create_time)
        values
        (#{id,jdbcType=BIGINT}, #{description,jdbcType=VARCHAR},
        #{projectId,jdbcType=BIGINT}, #{createTime,jdbcType=TIMESTAMP} )
    </insert>


    <select id="getBugList" resultMap="ResultMap" parameterType="com.zhixinhuixue.armor.model.dto.request.BugListReqDTO">
        SELECT (@rowid := @rowid+1) AS project_id,a.* FROM(SELECT b.id,b.description,b.create_time,a.users,project.name as projectName  FROM bug_manage b
          JOIN project on b.project_id = project.id
          JOIN (SELECT bug_id,group_concat(user.name separator ',') as users
        FROM bug_user JOIN  user on bug_user.user_id = user.id GROUP BY bug_id ORDER BY)a on a.bug_id = b.id
        <if test="userId!=null">
            JOIN (SELECT bug_id FROM bug_user WHERE user_id =#{userId})c on c.bug_id = b.id
        </if>
            WHERE  project_id!=0
            <if test="startTime!=null">
                <![CDATA[ AND b.create_time >= #{startTime} ]]>
            </if>
            <if test="endTime!=null">
                <![CDATA[ AND b.create_time <= #{endTime} ]]>
            </if>
            GROUP BY b.id
        )as a,(SELECT (@rowid:=0))as b
    </select>

    <select id="selectDetailById" resultMap="DetailResultMap">
        SELECT b.*,p.name as projectName FROM bug_manage b
        JOIN project p on b.project_id = p.id
                    where b.id = #{id}
    </select>

</mapper>